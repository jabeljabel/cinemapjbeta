<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMAP: Tokyo Film Time-Lapse</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', 'Noto Sans JP', sans-serif;
            background: #0a0a0f;
            color: #f0f0f0;
            overflow: hidden;
        }
        
        #map {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }
        
        /* Year Display */
        #year-display {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
        }
        
        .year-number {
            font-size: 96px;
            font-weight: 700;
            letter-spacing: -4px;
            color: #fff;
            text-shadow: 0 0 60px rgba(231,76,60,0.5);
            line-height: 1;
        }
        
        .year-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-top: 8px;
        }
        
        /* Controls */
        #controls {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        
        /* Timeline */
        .timeline-container {
            width: 600px;
            max-width: 90vw;
        }
        
        .timeline-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }
        
        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12);
            border-radius: 3px;
            transition: width 0.1s linear;
        }
        
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #555;
        }
        
        /* Playback controls */
        .playback-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(231,76,60,0.4);
            transition: all 0.2s;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(231,76,60,0.6);
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 12px;
        }
        
        .speed-btn, .view-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: #888;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }
        
        .speed-btn.active, .view-btn.active {
            background: rgba(231,76,60,0.3);
            color: #e74c3c;
        }
        
        .speed-btn:hover, .view-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Stats Panel */
        #stats {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            min-width: 180px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-row:last-child { border-bottom: none; }
        
        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        .stat-value.filming { color: #e74c3c; }
        .stat-value.represented { color: #3498db; }
        
        /* Title */
        #title {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 100;
        }
        
        .title-main {
            font-size: 20px;
            font-weight: 600;
        }
        
        .title-sub {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .title-jp {
            font-size: 14px;
            color: #888;
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 8px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: #888;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
        }
        
        .mode-btn.active {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.3);
            padding: 4px;
            border-radius: 8px;
        }
        
        .view-btn {
            padding: 8px 14px;
            border-radius: 6px;
        }
        
        /* Settings Panel */
        #settings-panel {
            position: fixed;
            top: 200px;
            right: 30px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 200px;
        }
        
        .settings-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 12px;
        }
        
        .slider-group {
            margin-bottom: 14px;
        }
        
        .slider-group:last-child { margin-bottom: 0; }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            color: #aaa;
        }
        
        .slider-value {
            font-weight: 600;
            color: #e74c3c;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        #heatmap-settings { display: block; }
        #points-settings { display: none; }
        
        /* Loading */
        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0a0a0f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loader {
            width: 48px; height: 48px;
            border: 3px solid #333;
            border-top-color: #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-msg {
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }
        
        /* Legend */
        #legend {
            position: fixed;
            bottom: 140px;
            right: 30px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .legend-item:last-child { margin-bottom: 0; }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .legend-dot.filming { background: #e74c3c; }
        .legend-dot.represented { background: #3498db; }
        
        @media (max-width: 700px) {
            .year-number { font-size: 64px; }
            .timeline-container { width: 90vw; }
            #stats { display: none; }
            #settings-panel { top: auto; bottom: 180px; right: 10px; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader"></div>
        <div class="loading-msg">Loading Tokyo film data...</div>
    </div>
    
    <div id="title">
        <div class="title-main">Tokyo Film Time-Lapse</div>
        <div class="title-jp">Êù±‰∫¨Êò†Áîª„É≠„Ç±Âú∞„ÅÆÂ§âÈÅ∑</div>
        <div class="title-sub">128 years of cinema locations</div>
    </div>
    
    <div id="year-display">
        <div class="year-number" id="current-year">1920</div>
        <div class="year-label">Year</div>
    </div>
    
    <div id="stats">
        <div class="stat-row">
            <span class="stat-label">Total Locations</span>
            <span class="stat-value" id="stat-total">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Filming</span>
            <span class="stat-value filming" id="stat-filming">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Represented</span>
            <span class="stat-value represented" id="stat-represented">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Films</span>
            <span class="stat-value" id="stat-films">0</span>
        </div>
    </div>
    
    <div id="settings-panel">
        <div id="heatmap-settings">
            <div class="settings-title">Heatmap Settings</div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>Radius</span>
                    <span class="slider-value" id="radius-val">20</span>
                </div>
                <input type="range" id="radius" min="5" max="50" value="20" oninput="updateSettings()">
            </div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>Blur</span>
                    <span class="slider-value" id="blur-val">15</span>
                </div>
                <input type="range" id="blur" min="5" max="40" value="15" oninput="updateSettings()">
            </div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>Intensity</span>
                    <span class="slider-value" id="intensity-val">0.8</span>
                </div>
                <input type="range" id="intensity" min="0.1" max="1.5" step="0.1" value="0.8" oninput="updateSettings()">
            </div>
        </div>
        
        <div id="points-settings">
            <div class="settings-title">Points Settings</div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>Point Size</span>
                    <span class="slider-value" id="pointsize-val">6</span>
                </div>
                <input type="range" id="pointsize" min="2" max="15" value="6" oninput="updateSettings()">
            </div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>Opacity</span>
                    <span class="slider-value" id="opacity-val">0.7</span>
                </div>
                <input type="range" id="opacity" min="0.2" max="1.0" step="0.1" value="0.7" oninput="updateSettings()">
            </div>
        </div>
    </div>
    
    <div id="legend">
        <div class="legend-item">
            <div class="legend-dot filming"></div>
            <span>Filming locations</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot represented"></div>
            <span>Represented locations</span>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div id="controls">
        <div class="timeline-container">
            <div class="timeline-bar" id="timeline">
                <div class="timeline-progress" id="timeline-progress"></div>
            </div>
            <div class="timeline-labels">
                <span id="label-start">1920</span>
                <span id="label-end">2020</span>
            </div>
        </div>
        
        <div class="playback-controls">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="cumulative" onclick="setMode('cumulative')">Cumulative</button>
                <button class="mode-btn" data-mode="decade" onclick="setMode('decade')">By Decade</button>
            </div>
            
            <div class="view-toggle">
                <button class="view-btn active" data-view="heatmap" onclick="setView('heatmap')">üî• Heatmap</button>
                <button class="view-btn" data-view="points" onclick="setView('points')">üìç Points</button>
            </div>
            
            <button class="play-btn" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
            
            <div class="speed-control">
                <span>Speed:</span>
                <button class="speed-btn" data-speed="500" onclick="setSpeed(500)">Slow</button>
                <button class="speed-btn active" data-speed="200" onclick="setSpeed(200)">Normal</button>
                <button class="speed-btn" data-speed="50" onclick="setSpeed(50)">Fast</button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        const DATA_FILE = 'tokyo_timelapse.json';
        
        let map = null;
        let data = null;
        let minYear = 1920;
        let maxYear = 2020;
        let currentYear = 1920;
        let isPlaying = false;
        let playInterval = null;
        let speed = 200;
        let mode = 'cumulative';
        let viewMode = 'heatmap';
        
        // Heatmap settings
        let heatRadius = 20;
        let heatBlur = 15;
        let heatIntensity = 0.8;
        
        // Points settings
        let pointSize = 6;
        let pointOpacity = 0.7;
        
        // Layers
        let filmingHeatLayer = null;
        let representedHeatLayer = null;
        let filmingPointsLayer = null;
        let representedPointsLayer = null;
        
        function initMap() {
            map = L.map('map', {
                center: [35.6762, 139.6503],
                zoom: 11,
                zoomControl: false
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OSM ¬© CARTO',
                maxZoom: 19
            }).addTo(map);
            
            L.control.zoom({ position: 'bottomleft' }).addTo(map);
        }
        
        async function loadData() {
            try {
                const response = await fetch(DATA_FILE);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                data = await response.json();
                minYear = data.metadata.min_year;
                maxYear = data.metadata.max_year;
                currentYear = minYear;
                
                document.getElementById('label-start').textContent = minYear;
                document.getElementById('label-end').textContent = maxYear;
                document.getElementById('current-year').textContent = minYear;
                
                if (data.metadata.center) {
                    map.setView(data.metadata.center, data.metadata.zoom || 11);
                }
                
                updateVisualization();
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.loading-msg').textContent = `Error: ${error.message}`;
            }
        }
        
        function updateSettings() {
            heatRadius = parseInt(document.getElementById('radius').value);
            heatBlur = parseInt(document.getElementById('blur').value);
            heatIntensity = parseFloat(document.getElementById('intensity').value);
            document.getElementById('radius-val').textContent = heatRadius;
            document.getElementById('blur-val').textContent = heatBlur;
            document.getElementById('intensity-val').textContent = heatIntensity.toFixed(1);
            
            pointSize = parseInt(document.getElementById('pointsize').value);
            pointOpacity = parseFloat(document.getElementById('opacity').value);
            document.getElementById('pointsize-val').textContent = pointSize;
            document.getElementById('opacity-val').textContent = pointOpacity.toFixed(1);
            
            updateVisualization();
        }
        
        function setView(newView) {
            viewMode = newView;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === newView);
            });
            
            document.getElementById('heatmap-settings').style.display = newView === 'heatmap' ? 'block' : 'none';
            document.getElementById('points-settings').style.display = newView === 'points' ? 'block' : 'none';
            
            updateVisualization();
        }
        
        function clearLayers() {
            if (filmingHeatLayer) { map.removeLayer(filmingHeatLayer); filmingHeatLayer = null; }
            if (representedHeatLayer) { map.removeLayer(representedHeatLayer); representedHeatLayer = null; }
            if (filmingPointsLayer) { map.removeLayer(filmingPointsLayer); filmingPointsLayer = null; }
            if (representedPointsLayer) { map.removeLayer(representedPointsLayer); representedPointsLayer = null; }
        }
        
        function updateVisualization() {
            clearLayers();
            
            const filmingLocs = [];
            const representedLocs = [];
            let totalFilming = 0;
            let totalRepresented = 0;
            
            const startYear = mode === 'decade' 
                ? Math.floor(currentYear / 10) * 10 
                : minYear;
            const endYear = mode === 'decade' 
                ? startYear + 9 
                : currentYear;
            
            for (let year = startYear; year <= Math.min(endYear, currentYear); year++) {
                const yearData = data.years[String(year)];
                if (!yearData) continue;
                
                yearData.locations.forEach(loc => {
                    if (loc.type === 'filming') {
                        filmingLocs.push(loc);
                        totalFilming++;
                    } else {
                        representedLocs.push(loc);
                        totalRepresented++;
                    }
                });
            }
            
            if (viewMode === 'heatmap') {
                renderHeatmap(filmingLocs, representedLocs);
            } else {
                renderPoints(filmingLocs, representedLocs);
            }
            
            document.getElementById('stat-total').textContent = (totalFilming + totalRepresented).toLocaleString();
            document.getElementById('stat-filming').textContent = totalFilming.toLocaleString();
            document.getElementById('stat-represented').textContent = totalRepresented.toLocaleString();
            
            let cumulativeFilms = 0;
            for (let y = minYear; y <= currentYear; y++) {
                const yd = data.years[String(y)];
                if (yd && yd.film_count) cumulativeFilms += yd.film_count;
            }
            document.getElementById('stat-films').textContent = cumulativeFilms.toLocaleString();
            
            document.getElementById('current-year').textContent = currentYear;
            
            const progress = ((currentYear - minYear) / (maxYear - minYear)) * 100;
            document.getElementById('timeline-progress').style.width = `${progress}%`;
        }
        
        function renderHeatmap(filmingLocs, representedLocs) {
            const filmingPoints = filmingLocs.map(loc => [loc.lat, loc.lon, heatIntensity]);
            const representedPoints = representedLocs.map(loc => [loc.lat, loc.lon, heatIntensity]);
            
            if (filmingPoints.length > 0) {
                filmingHeatLayer = L.heatLayer(filmingPoints, {
                    radius: heatRadius,
                    blur: heatBlur,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.2: '#ffcccc',
                        0.4: '#ff6b6b',
                        0.6: '#ee5a24',
                        0.8: '#e74c3c',
                        1: '#c0392b'
                    }
                }).addTo(map);
            }
            
            if (representedPoints.length > 0) {
                representedHeatLayer = L.heatLayer(representedPoints, {
                    radius: heatRadius,
                    blur: heatBlur,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.2: '#cce5ff',
                        0.4: '#74b9ff',
                        0.6: '#0984e3',
                        0.8: '#3498db',
                        1: '#2980b9'
                    }
                }).addTo(map);
            }
        }
        
        function renderPoints(filmingLocs, representedLocs) {
            filmingPointsLayer = L.layerGroup();
            representedPointsLayer = L.layerGroup();
            
            filmingLocs.forEach(loc => {
                const marker = L.circleMarker([loc.lat, loc.lon], {
                    radius: pointSize,
                    fillColor: '#e74c3c',
                    color: '#c0392b',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: pointOpacity
                });
                filmingPointsLayer.addLayer(marker);
            });
            
            representedLocs.forEach(loc => {
                const marker = L.circleMarker([loc.lat, loc.lon], {
                    radius: pointSize,
                    fillColor: '#3498db',
                    color: '#2980b9',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: pointOpacity
                });
                representedPointsLayer.addLayer(marker);
            });
            
            representedPointsLayer.addTo(map);
            filmingPointsLayer.addTo(map);
        }
        
        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('play-btn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
            
            if (isPlaying) {
                if (currentYear >= maxYear) {
                    currentYear = minYear;
                }
                playInterval = setInterval(() => {
                    currentYear++;
                    if (currentYear > maxYear) {
                        currentYear = maxYear;
                        togglePlay();
                        return;
                    }
                    updateVisualization();
                }, speed);
            } else {
                clearInterval(playInterval);
            }
        }
        
        function setSpeed(newSpeed) {
            speed = newSpeed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.speed) === newSpeed);
            });
            
            if (isPlaying) {
                clearInterval(playInterval);
                playInterval = setInterval(() => {
                    currentYear++;
                    if (currentYear > maxYear) {
                        currentYear = maxYear;
                        togglePlay();
                        return;
                    }
                    updateVisualization();
                }, speed);
            }
        }
        
        function setMode(newMode) {
            mode = newMode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === newMode);
            });
            updateVisualization();
        }
        
        document.getElementById('timeline').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const pct = x / rect.width;
            currentYear = Math.round(minYear + pct * (maxYear - minYear));
            currentYear = Math.max(minYear, Math.min(maxYear, currentYear));
            updateVisualization();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlay();
            } else if (e.code === 'ArrowRight') {
                currentYear = Math.min(maxYear, currentYear + 1);
                updateVisualization();
            } else if (e.code === 'ArrowLeft') {
                currentYear = Math.max(minYear, currentYear - 1);
                updateVisualization();
            } else if (e.code === 'KeyH') {
                setView('heatmap');
            } else if (e.code === 'KeyP') {
                setView('points');
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();
        });
    </script>
</body>
</html>
