<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagination Distance - CineMAP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 36px;
            font-weight: 700;
            color: #f4d03f;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            color: #888;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Methodology Box */
        .methodology {
            background: rgba(244, 208, 63, 0.1);
            border: 1px solid rgba(244, 208, 63, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0 30px;
        }
        
        .methodology h3 {
            color: #f4d03f;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .methodology p {
            font-size: 13px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .methodology-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .centroid-box {
            text-align: center;
            padding: 10px 20px;
            border-radius: 8px;
        }
        
        .centroid-box.filming {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
        }
        
        .centroid-box.represented {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid #9b59b6;
        }
        
        .centroid-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }
        
        .centroid-title {
            font-size: 14px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .arrow {
            font-size: 24px;
            color: #f4d03f;
        }
        
        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #f4d03f;
        }
        
        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        select {
            padding: 10px 15px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 13px;
            min-width: 180px;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #f4d03f;
        }
        
        /* Distribution Chart */
        .distribution-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .distribution-chart {
            height: 80px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            gap: 2px;
        }
        
        .dist-bar {
            flex: 1;
            background: linear-gradient(to top, #f4d03f, #e67e22);
            border-radius: 2px 2px 0 0;
            min-width: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .dist-bar:hover {
            background: linear-gradient(to top, #f1c40f, #f39c12);
            transform: scaleY(1.1);
            transform-origin: bottom;
        }
        
        .dist-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }
        
        /* Strip Plot */
        .strip-plot-container {
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .strip-plot {
            position: relative;
            height: 300px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .strip-axis {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            padding: 8px 10px 0;
        }
        
        .axis-label {
            font-size: 10px;
            color: #666;
        }
        
        .strip-canvas {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 40px;
        }
        
        .film-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            opacity: 0.7;
        }
        
        .film-dot:hover {
            transform: scale(2);
            opacity: 1;
            z-index: 100;
            box-shadow: 0 0 10px currentColor;
        }
        
        .film-dot.selected {
            transform: scale(2.5);
            opacity: 1;
            z-index: 101;
            box-shadow: 0 0 15px currentColor, 0 0 30px currentColor;
        }
        
        /* Genre Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .legend-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .legend-item.active {
            background: rgba(255,255,255,0.15);
            color: #e0e0e0;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        /* Film List */
        .film-list-section {
            margin-top: 30px;
        }
        
        .film-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .film-count {
            font-size: 13px;
            color: #888;
        }
        
        .sort-controls {
            display: flex;
            gap: 8px;
        }
        
        .sort-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.08);
            border: none;
            border-radius: 6px;
            color: #888;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sort-btn.active {
            background: rgba(244, 208, 63, 0.2);
            color: #f4d03f;
        }
        
        .sort-btn:hover {
            background: rgba(255,255,255,0.12);
        }
        
        .film-list {
            display: grid;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .film-row {
            display: grid;
            grid-template-columns: 1fr 120px 100px;
            gap: 15px;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .film-row:hover {
            background: rgba(255,255,255,0.08);
        }
        
        .film-row.selected {
            background: rgba(244, 208, 63, 0.15);
            border: 1px solid rgba(244, 208, 63, 0.3);
        }
        
        .film-info {
            min-width: 0;
        }
        
        .film-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .film-meta {
            font-size: 11px;
            color: #888;
            margin-top: 3px;
        }
        
        .film-bar-container {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .film-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .film-distance {
            font-size: 14px;
            font-weight: 600;
            color: #f4d03f;
            text-align: right;
        }
        
        /* Detail Panel */
        .detail-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: rgba(20, 20, 35, 0.98);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 25px;
            z-index: 1000;
            display: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .detail-panel.active {
            display: block;
        }
        
        .detail-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        
        .detail-title {
            font-size: 20px;
            font-weight: 600;
            color: #f4d03f;
            margin-bottom: 5px;
            padding-right: 30px;
        }
        
        .detail-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }
        
        .detail-distance {
            text-align: center;
            padding: 20px;
            background: rgba(244, 208, 63, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .detail-distance-value {
            font-size: 48px;
            font-weight: 700;
            color: #f4d03f;
        }
        
        .detail-distance-unit {
            font-size: 18px;
            color: #888;
        }
        
        .detail-distance-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .detail-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .detail-stat {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            text-align: center;
        }
        
        .detail-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .detail-stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            margin-top: 3px;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* Back button */
        .back-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            z-index: 100;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: rgba(30, 30, 50, 0.95);
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #888;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(244, 208, 63, 0.2);
            border-top-color: #f4d03f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Imagination Distance</h1>
            <p class="subtitle">
                How far is a film's story from where it was actually shot? 
                This visualization compares the geographic imagination of Japanese cinema.
            </p>
        </header>
        
        <div class="methodology">
            <h3>How It Works</h3>
            <p>
                For each film with both filming locations and story mentions (from subtitles, synopses, and titles), 
                we calculate the average position of each set. The "imagination distance" is the great-circle 
                distance between these two centroids ‚Äî measuring how far a film's narrative travels from its production reality.
            </p>
            <div class="methodology-diagram">
                <div class="centroid-box filming">
                    <div class="centroid-label">Filming Centroid</div>
                    <div class="centroid-title" style="color: #3498db;">üìç Where cameras rolled</div>
                </div>
                <div class="arrow">‚ü∑</div>
                <div class="centroid-box represented">
                    <div class="centroid-label">Story Centroid</div>
                    <div class="centroid-title" style="color: #9b59b6;">üìñ Where story is set</div>
                </div>
            </div>
        </div>
        
        <div class="stats-row" id="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="stat-films">-</div>
                <div class="stat-label">Films Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg">-</div>
                <div class="stat-label">Average (km)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-median">-</div>
                <div class="stat-label">Median (km)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-local">-</div>
                <div class="stat-label">Local (&lt;50km)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-distant">-</div>
                <div class="stat-label">Distant (&gt;500km)</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <span class="control-label">Decade</span>
                <select id="filter-decade">
                    <option value="">All Decades</option>
                </select>
            </div>
            <div class="control-group">
                <span class="control-label">Color By</span>
                <select id="color-by">
                    <option value="distance">Distance Range</option>
                    <option value="decade">Decade</option>
                </select>
            </div>
            <div class="control-group">
                <span class="control-label">Max Distance</span>
                <select id="filter-max">
                    <option value="99999">All Films</option>
                    <option value="100">Under 100 km (local)</option>
                    <option value="300">Under 300 km (regional)</option>
                    <option value="500">Under 500 km</option>
                    <option value="1000">Under 1000 km (Japan only)</option>
                </select>
            </div>
        </div>
        
        <div class="distribution-section">
            <div class="section-title">Distance Distribution</div>
            <div class="distribution-chart" id="distribution"></div>
            <div class="dist-labels">
                <span>0 km</span>
                <span>100</span>
                <span>200</span>
                <span>300</span>
                <span>400</span>
                <span>500+</span>
            </div>
        </div>
        
        <div class="strip-plot-container">
            <div class="section-title">All Films by Imagination Distance</div>
            <div class="strip-plot">
                <div class="strip-canvas" id="strip-canvas"></div>
                <div class="strip-axis">
                    <span class="axis-label">0 km</span>
                    <span class="axis-label">100</span>
                    <span class="axis-label">200</span>
                    <span class="axis-label">300</span>
                    <span class="axis-label">400</span>
                    <span class="axis-label">500+ km</span>
                </div>
            </div>
            <div class="legend" id="legend"></div>
        </div>
        
        <div class="film-list-section">
            <div class="film-list-header">
                <div class="section-title">Film Rankings</div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span class="film-count" id="film-count">Showing 0 films</span>
                    <div class="sort-controls">
                        <button class="sort-btn active" data-sort="desc">Highest First</button>
                        <button class="sort-btn" data-sort="asc">Lowest First</button>
                    </div>
                </div>
            </div>
            <div class="film-list" id="film-list"></div>
        </div>
    </div>
    
    <div class="overlay" id="overlay" onclick="closeDetail()"></div>
    <div class="detail-panel" id="detail-panel">
        <button class="detail-close" onclick="closeDetail()">√ó</button>
        <div class="detail-title" id="detail-title">-</div>
        <div class="detail-subtitle" id="detail-subtitle">-</div>
        <div class="detail-distance">
            <div class="detail-distance-value" id="detail-distance">-</div>
            <div class="detail-distance-unit">km</div>
            <div class="detail-distance-label">Imagination Distance</div>
        </div>
        <div class="detail-stats">
            <div class="detail-stat">
                <div class="detail-stat-value" id="detail-filming">-</div>
                <div class="detail-stat-label">Filming Locations</div>
            </div>
            <div class="detail-stat">
                <div class="detail-stat-value" id="detail-represented">-</div>
                <div class="detail-stat-label">Story Mentions</div>
            </div>
            <div class="detail-stat">
                <div class="detail-stat-value" id="detail-year">-</div>
                <div class="detail-stat-label">Year</div>
            </div>
            <div class="detail-stat">
                <div class="detail-stat-value" id="detail-percentile">-</div>
                <div class="detail-stat-label">Percentile</div>
            </div>
        </div>
    </div>
    
    <a href="../index.html" class="back-btn">‚Üê Back to CineMAP</a>
    
    <script>
        // === DATA & STATE ===
        let allFilms = [];
        let filteredFilms = [];
        let maxDistance = 500;  // Cap for visualization
        let sortOrder = 'desc';
        let selectedFilm = null;
        
        // Color schemes
        const distanceColors = {
            0: '#2ecc71',    // Green: very local
            50: '#27ae60',
            100: '#f1c40f',  // Yellow: regional
            200: '#e67e22',  // Orange
            300: '#d35400',
            500: '#e74c3c'   // Red: distant
        };
        
        const decadeColors = {
            '1890': '#9b59b6',
            '1900': '#8e44ad',
            '1910': '#3498db',
            '1920': '#2980b9',
            '1930': '#1abc9c',
            '1940': '#16a085',
            '1950': '#f1c40f',
            '1960': '#f39c12',
            '1970': '#e67e22',
            '1980': '#d35400',
            '1990': '#e74c3c',
            '2000': '#c0392b',
            '2010': '#9b59b6',
            '2020': '#8e44ad'
        };
        
        // === INITIALIZATION ===
        async function init() {
            try {
                const response = await fetch('imagination_distance.json');
                const data = await response.json();
                
                allFilms = data.films;
                
                // Update stats
                document.getElementById('stat-films').textContent = data.summary.films_analyzed.toLocaleString();
                document.getElementById('stat-avg').textContent = Math.round(data.summary.avg_distance_km).toLocaleString();
                document.getElementById('stat-median').textContent = Math.round(data.summary.median_distance_km).toLocaleString();
                
                const localCount = allFilms.filter(f => f.dist < 50).length;
                const distantCount = allFilms.filter(f => f.dist > 500).length;
                document.getElementById('stat-local').textContent = `${Math.round(localCount / allFilms.length * 100)}%`;
                document.getElementById('stat-distant').textContent = `${Math.round(distantCount / allFilms.length * 100)}%`;
                
                // Populate decade filter
                const decades = [...new Set(allFilms.map(f => f.year ? Math.floor(f.year / 10) * 10 : null).filter(Boolean))].sort();
                const decadeSelect = document.getElementById('filter-decade');
                decades.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = `${d}s`;
                    decadeSelect.appendChild(opt);
                });
                
                // Build legend
                buildLegend();
                
                // Initial render
                applyFilters();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.container').innerHTML = `
                    <div class="loading">
                        <h2 style="color: #e74c3c;">Error Loading Data</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function buildLegend() {
            const legend = document.getElementById('legend');
            const colorBy = document.getElementById('color-by').value;
            
            if (colorBy === 'distance') {
                legend.innerHTML = `
                    <div class="legend-item"><div class="legend-dot" style="background: #2ecc71;"></div> &lt;50 km</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #f1c40f;"></div> 50-100 km</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #e67e22;"></div> 100-200 km</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #d35400;"></div> 200-300 km</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #e74c3c;"></div> 300+ km</div>
                `;
            } else {
                legend.innerHTML = Object.entries(decadeColors).map(([decade, color]) => `
                    <div class="legend-item"><div class="legend-dot" style="background: ${color};"></div> ${decade}s</div>
                `).join('');
            }
        }
        
        function getColor(film) {
            const colorBy = document.getElementById('color-by').value;
            
            if (colorBy === 'decade') {
                const decade = film.year ? Math.floor(film.year / 10) * 10 : 1950;
                return decadeColors[decade] || '#888';
            }
            
            // Color by distance
            const d = film.dist;
            if (d < 50) return '#2ecc71';
            if (d < 100) return '#f1c40f';
            if (d < 200) return '#e67e22';
            if (d < 300) return '#d35400';
            return '#e74c3c';
        }
        
        function applyFilters() {
            const decade = document.getElementById('filter-decade').value;
            const maxDist = parseInt(document.getElementById('filter-max').value);
            
            filteredFilms = allFilms.filter(f => {
                if (decade && f.year && Math.floor(f.year / 10) * 10 !== parseInt(decade)) return false;
                if (f.dist > maxDist) return false;
                return true;
            });
            
            // Sort
            filteredFilms.sort((a, b) => sortOrder === 'desc' ? b.dist - a.dist : a.dist - b.dist);
            
            updateDistribution();
            updateStripPlot();
            updateFilmList();
            
            document.getElementById('film-count').textContent = `Showing ${filteredFilms.length.toLocaleString()} films`;
        }
        
        function updateDistribution() {
            const container = document.getElementById('distribution');
            const buckets = [0, 10, 20, 30, 40, 50, 75, 100, 150, 200, 250, 300, 350, 400, 450, 500];
            
            const counts = buckets.map((min, i) => {
                const max = buckets[i + 1] || Infinity;
                return filteredFilms.filter(f => f.dist >= min && f.dist < max).length;
            });
            
            const maxCount = Math.max(...counts, 1);
            
            container.innerHTML = counts.map((count, i) => {
                const height = (count / maxCount * 100);
                const bucket = buckets[i];
                return `<div class="dist-bar" style="height: ${height}%; background: ${getDistColor(bucket)};" 
                            title="${buckets[i]}-${buckets[i+1] || '500+'} km: ${count} films"></div>`;
            }).join('');
        }
        
        function getDistColor(d) {
            if (d < 50) return '#2ecc71';
            if (d < 100) return '#f1c40f';
            if (d < 200) return '#e67e22';
            if (d < 300) return '#d35400';
            return '#e74c3c';
        }
        
        function updateStripPlot() {
            const canvas = document.getElementById('strip-canvas');
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            
            // Sample if too many films
            let displayFilms = filteredFilms;
            if (displayFilms.length > 2000) {
                // Take every nth film to get ~2000
                const step = Math.ceil(displayFilms.length / 2000);
                displayFilms = displayFilms.filter((_, i) => i % step === 0);
            }
            
            // Calculate positions with jittering
            const maxDist = Math.min(500, Math.max(...filteredFilms.map(f => f.dist)));
            const positions = displayFilms.map((film, i) => {
                const x = Math.min(film.dist, 500) / 500 * width;
                // Jitter y position based on hash of film id
                const hash = (film.id * 2654435761) % 1000;
                const y = (hash / 1000) * height;
                return { film, x, y };
            });
            
            canvas.innerHTML = positions.map(p => `
                <div class="film-dot" 
                     style="left: ${p.x}px; top: ${p.y}px; background: ${getColor(p.film)};"
                     data-id="${p.film.id}"
                     onclick="showDetail(${p.film.id})"
                     title="${p.film.en || p.film.jp}: ${Math.round(p.film.dist)} km">
                </div>
            `).join('');
        }
        
        function updateFilmList() {
            const container = document.getElementById('film-list');
            const maxDist = Math.max(...filteredFilms.map(f => f.dist), 1);
            
            // Show top 100
            const displayFilms = filteredFilms.slice(0, 100);
            
            container.innerHTML = displayFilms.map((film, i) => {
                const barWidth = Math.min(film.dist, 500) / 500 * 100;
                const color = getColor(film);
                const rank = sortOrder === 'desc' ? i + 1 : filteredFilms.length - i;
                
                return `
                    <div class="film-row" onclick="showDetail(${film.id})" data-id="${film.id}">
                        <div class="film-info">
                            <div class="film-title">${film.en || film.jp || 'Unknown'}</div>
                            <div class="film-meta">${film.jp && film.en ? film.jp + ' ¬∑ ' : ''}${film.year || 'Unknown year'}</div>
                        </div>
                        <div class="film-bar-container">
                            <div class="film-bar" style="width: ${barWidth}%; background: ${color};"></div>
                        </div>
                        <div class="film-distance">${Math.round(film.dist).toLocaleString()} km</div>
                    </div>
                `;
            }).join('');
        }
        
        function showDetail(filmId) {
            const film = allFilms.find(f => f.id === filmId);
            if (!film) return;
            
            selectedFilm = film;
            
            // Calculate percentile
            const rank = allFilms.filter(f => f.dist <= film.dist).length;
            const percentile = Math.round(rank / allFilms.length * 100);
            
            document.getElementById('detail-title').textContent = film.en || film.jp || 'Unknown';
            document.getElementById('detail-subtitle').textContent = film.jp && film.en ? film.jp : (film.year ? `(${film.year})` : '');
            document.getElementById('detail-distance').textContent = Math.round(film.dist).toLocaleString();
            document.getElementById('detail-filming').textContent = film.f_n;
            document.getElementById('detail-represented').textContent = film.r_n;
            document.getElementById('detail-year').textContent = film.year || 'Unknown';
            document.getElementById('detail-percentile').textContent = `${percentile}%`;
            
            document.getElementById('overlay').classList.add('active');
            document.getElementById('detail-panel').classList.add('active');
            
            // Highlight in list and plot
            document.querySelectorAll('.film-row').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.film-dot').forEach(el => el.classList.remove('selected'));
            
            const row = document.querySelector(`.film-row[data-id="${filmId}"]`);
            if (row) row.classList.add('selected');
            
            const dot = document.querySelector(`.film-dot[data-id="${filmId}"]`);
            if (dot) dot.classList.add('selected');
        }
        
        function closeDetail() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('detail-panel').classList.remove('active');
            
            document.querySelectorAll('.film-row').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.film-dot').forEach(el => el.classList.remove('selected'));
            
            selectedFilm = null;
        }
        
        // === EVENT LISTENERS ===
        document.getElementById('filter-decade').addEventListener('change', applyFilters);
        document.getElementById('filter-max').addEventListener('change', applyFilters);
        document.getElementById('color-by').addEventListener('change', () => {
            buildLegend();
            updateStripPlot();
            updateFilmList();
        });
        
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sortOrder = btn.dataset.sort;
                applyFilters();
            });
        });
        
        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeDetail();
        });
        
        // Resize
        window.addEventListener('resize', () => {
            if (filteredFilms.length > 0) updateStripPlot();
        });
        
        // Start
        init();
    </script>
</body>
</html>
