<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMAP: Genre Geography Heatmap</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'DM Sans', 'Noto Sans JP', sans-serif;
            background: #f8f9fa;
            color: #1a1a1a;
            overflow: hidden;
        }
        
        #header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 200;
        }
        
        .header-title { font-size: 16px; font-weight: 700; }
        .header-title span { font-weight: 400; color: #888; margin-left: 8px; }
        .header-controls { display: flex; gap: 8px; }
        
        .header-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            color: #555;
            cursor: pointer;
        }
        
        .header-btn:hover { background: #e0e0e0; }
        .header-btn.active { background: #1a1a1a; color: white; }
        
        #map {
            position: fixed;
            top: 56px; left: 0; right: 320px; bottom: 0;
            z-index: 1;
        }
        
        #sidebar {
            position: fixed;
            top: 56px; right: 0;
            width: 320px;
            height: calc(100vh - 56px);
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 12px;
        }
        
        /* Genre List */
        .genre-list { display: flex; flex-direction: column; gap: 4px; }
        
        .genre-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
            font-size: 12px;
        }
        
        .genre-item:hover { background: #f0f0f0; }
        .genre-item.active { border-color: var(--genre-color); background: white; }
        .genre-item.inactive { opacity: 0.25; }
        
        .genre-handle { cursor: grab; color: #ccc; font-size: 10px; }
        .genre-swatch { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }
        .genre-name { flex: 1; font-weight: 500; }
        .genre-count { font-size: 10px; color: #888; }
        .genre-toggle { font-size: 10px; color: #888; }
        
        .layer-btns { display: flex; gap: 2px; margin-left: 4px; }
        
        .layer-btn {
            width: 18px; height: 18px;
            border: none;
            background: #e8e8e8;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .layer-btn:hover { background: #ddd; }
        
        /* Sliders */
        .slider-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .slider-group { flex: 1; }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
            color: #666;
        }
        
        .slider-value { font-weight: 600; color: #3498db; }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        /* Buttons */
        .btn-row { display: flex; gap: 8px; margin-bottom: 12px; }
        
        .action-btn {
            flex: 1;
            padding: 8px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .action-btn:hover { background: #e0e0e0; }
        
        /* Stats */
        .stats-row { display: flex; gap: 8px; }
        
        .stat-box {
            flex: 1;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-value { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 9px; color: #888; text-transform: uppercase; }
        
        /* Loading */
        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loader {
            width: 36px; height: 36px;
            border: 3px solid #f0f0f0;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-msg { margin-top: 12px; font-size: 12px; color: #888; }
        
        .progress-bar {
            width: 200px;
            height: 4px;
            background: #f0f0f0;
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3498db;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .info-text {
            font-size: 11px;
            color: #888;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            #map { right: 0; bottom: 220px; }
            #sidebar { width: 100%; height: 220px; top: auto; bottom: 0; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader"></div>
        <div class="loading-msg" id="loading-msg">Loading metadata...</div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div>
    </div>
    
    <div id="header">
        <div class="header-title">CineMAP <span>Genre Heatmaps</span></div>
        <div class="header-controls">
            <button class="header-btn active" data-type="filming" onclick="toggleLocationType('filming')">Filming</button>
            <button class="header-btn active" data-type="represented" onclick="toggleLocationType('represented')">Represented</button>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div id="sidebar">
        <div class="sidebar-section">
            <div class="section-title">Heatmap Settings</div>
            <div class="slider-row">
                <div class="slider-group">
                    <div class="slider-label"><span>Radius</span><span class="slider-value" id="radius-val">18</span></div>
                    <input type="range" id="radius" min="8" max="35" value="18" oninput="updateSettings()">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>Blur</span><span class="slider-value" id="blur-val">12</span></div>
                    <input type="range" id="blur" min="5" max="25" value="12" oninput="updateSettings()">
                </div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="section-title">Genres (Drag to Reorder Layers)</div>
            <div class="btn-row">
                <button class="action-btn" onclick="toggleAll()">Toggle All</button>
                <button class="action-btn" onclick="soloMode()">Solo Selected</button>
            </div>
            <div class="genre-list" id="genre-list"></div>
            <div class="info-text" style="margin-top: 10px;">
                ⬆⬇ buttons or drag to change layer order. Top = front.
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="section-title">Statistics</div>
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="stat-genres">—</div>
                    <div class="stat-label">Genres</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-visible">—</div>
                    <div class="stat-label">Locations</div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        // =====================================================================
        // CONFIGURATION - Update this suffix after running export script!
        // =====================================================================
        const DATA_SUFFIX = '930764b3f16e63e2';
        
        const META_FILE = `cg_${DATA_SUFFIX}_meta.json`;
        
        // Genre colors
        const GENRE_COLORS = {
            'drama': '#3498db',
            'action': '#e74c3c',
            'comedy': '#f1c40f',
            'romance': '#e91e63',
            'animation': '#ff9800',
            'horror': '#9b59b6',
            'documentary': '#795548',
            'biography': '#4caf50',
            'crime': '#00bcd4',
            'adventure': '#16a085',
            'mystery': '#673ab7',
            'thriller': '#607d8b',
            'war': '#455a64',
            'fantasy': '#8e44ad',
            'music': '#c0392b'
        };
        
        function getGradient(color) {
            return {
                0.4: lightenColor(color, 60),
                0.7: lightenColor(color, 30),
                1: color
            };
        }
        
        function lightenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }
        
        let allData = [];
        let metadata = null;
        let genreOrder = [];
        let genreVisibility = {};
        let locationTypeVisibility = { filming: true, represented: true };
        let heatmapLayers = {};
        let map = null;
        let allVisible = true;
        let lastSelected = null;
        
        function initMap() {
            map = L.map('map', { center: [36.5, 138.0], zoom: 6 });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© OSM © CARTO',
                maxZoom: 19
            }).addTo(map);
        }
        
        async function loadData() {
            try {
                // Load metadata first
                document.getElementById('loading-msg').textContent = 'Loading metadata...';
                const metaResponse = await fetch(META_FILE);
                if (!metaResponse.ok) throw new Error(`Metadata: ${metaResponse.status}`);
                
                metadata = await metaResponse.json();
                
                // Load chunks
                const totalChunks = metadata.chunk_files.length;
                for (let i = 0; i < totalChunks; i++) {
                    document.getElementById('loading-msg').textContent = `Loading data ${i + 1}/${totalChunks}...`;
                    document.getElementById('progress-fill').style.width = `${((i + 1) / totalChunks) * 100}%`;
                    
                    const chunkResponse = await fetch(metadata.chunk_files[i]);
                    if (!chunkResponse.ok) throw new Error(`Chunk ${i}: ${chunkResponse.status}`);
                    
                    const chunkData = await chunkResponse.json();
                    allData = allData.concat(chunkData);
                }
                
                document.getElementById('loading-msg').textContent = 'Processing...';
                
                // Setup genre order from categories
                genreOrder = Object.keys(metadata.categories);
                for (const key of genreOrder) {
                    genreVisibility[key] = true;
                }
                
                buildGenreList();
                updateStats();
                createHeatmaps();
                
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-msg').textContent = `Error: ${error.message}`;
            }
        }
        
        function updateStats() {
            // Calculate total locations from metadata
            let totalLocations = 0;
            for (const key of genreOrder) {
                const info = metadata.categories[key];
                if (info) {
                    totalLocations += info.filming_locations + info.represented_locations;
                }
            }
            document.getElementById('stat-genres').textContent = genreOrder.length;
            document.getElementById('stat-visible').textContent = (totalLocations / 1000).toFixed(0) + 'k';
        }
        
        function createHeatmaps() {
            for (const layer of Object.values(heatmapLayers)) {
                map.removeLayer(layer);
            }
            heatmapLayers = {};
            
            const radius = parseInt(document.getElementById('radius').value);
            const blur = parseInt(document.getElementById('blur').value);
            
            // Group data by genre
            const dataByGenre = {};
            for (const key of genreOrder) {
                dataByGenre[key] = [];
            }
            
            let visibleCount = 0;
            
            allData.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates;
                const category = props.c;
                const locType = props.lt === 'f' ? 'filming' : 'represented';
                
                if (!genreOrder.includes(category)) return;
                if (!genreVisibility[category]) return;
                if (!locationTypeVisibility[locType]) return;
                
                dataByGenre[category].push([coords[1], coords[0], 0.5]);
                visibleCount++;
            });
            
            // Create heatmaps in order
            for (const key of genreOrder) {
                const points = dataByGenre[key];
                if (points.length === 0 || !genreVisibility[key]) continue;
                
                const catInfo = metadata.categories[key];
                const color = catInfo?.color || GENRE_COLORS[key] || '#888888';
                const gradient = getGradient(color);
                
                heatmapLayers[key] = L.heatLayer(points, {
                    radius: radius,
                    blur: blur,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: gradient,
                    minOpacity: 0.15
                });
                
                heatmapLayers[key].addTo(map);
            }
            
            document.getElementById('stat-visible').textContent = (visibleCount / 1000).toFixed(0) + 'k';
        }
        
        function updateSettings() {
            document.getElementById('radius-val').textContent = document.getElementById('radius').value;
            document.getElementById('blur-val').textContent = document.getElementById('blur').value;
            createHeatmaps();
        }
        
        function buildGenreList() {
            const container = document.getElementById('genre-list');
            container.innerHTML = '';
            
            const displayOrder = [...genreOrder].reverse();
            
            for (const key of displayOrder) {
                const info = metadata.categories[key];
                if (!info) continue;
                
                const total = info.filming_locations + info.represented_locations;
                const color = info.color || GENRE_COLORS[key] || '#888';
                
                const item = document.createElement('div');
                item.className = `genre-item ${genreVisibility[key] ? 'active' : 'inactive'}`;
                item.dataset.genre = key;
                item.style.setProperty('--genre-color', color);
                item.draggable = true;
                
                item.innerHTML = `
                    <span class="genre-handle">☰</span>
                    <div class="genre-swatch" style="background: ${color}"></div>
                    <span class="genre-name">${info.name}</span>
                    <span class="genre-count">${(total / 1000).toFixed(0)}k</span>
                    <div class="layer-btns">
                        <button class="layer-btn" onclick="event.stopPropagation(); moveLayer('${key}', 'up')" title="Bring Forward">↑</button>
                        <button class="layer-btn" onclick="event.stopPropagation(); moveLayer('${key}', 'down')" title="Send Back">↓</button>
                    </div>
                    <span class="genre-toggle">${genreVisibility[key] ? '●' : '○'}</span>
                `;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('layer-btn')) {
                        toggleGenre(key);
                    }
                });
                
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                
                container.appendChild(item);
            }
            
            document.getElementById('stat-genres').textContent = genreOrder.length;
        }
        
        let draggedGenre = null;
        
        function handleDragStart(e) {
            draggedGenre = e.target.dataset.genre;
            e.target.classList.add('dragging');
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedGenre = null;
        }
        
        function handleDragOver(e) { e.preventDefault(); }
        
        function handleDrop(e) {
            e.preventDefault();
            const targetGenre = e.target.closest('.genre-item')?.dataset.genre;
            if (!targetGenre || !draggedGenre || targetGenre === draggedGenre) return;
            
            const dragIdx = genreOrder.indexOf(draggedGenre);
            const targetIdx = genreOrder.indexOf(targetGenre);
            
            genreOrder.splice(dragIdx, 1);
            genreOrder.splice(targetIdx, 0, draggedGenre);
            
            buildGenreList();
            createHeatmaps();
        }
        
        function moveLayer(key, direction) {
            const idx = genreOrder.indexOf(key);
            if (idx === -1) return;
            
            if (direction === 'up' && idx < genreOrder.length - 1) {
                [genreOrder[idx], genreOrder[idx + 1]] = [genreOrder[idx + 1], genreOrder[idx]];
            } else if (direction === 'down' && idx > 0) {
                [genreOrder[idx], genreOrder[idx - 1]] = [genreOrder[idx - 1], genreOrder[idx]];
            }
            
            buildGenreList();
            createHeatmaps();
        }
        
        function toggleGenre(key) {
            genreVisibility[key] = !genreVisibility[key];
            lastSelected = key;
            
            const item = document.querySelector(`.genre-item[data-genre="${key}"]`);
            if (item) {
                item.classList.toggle('active', genreVisibility[key]);
                item.classList.toggle('inactive', !genreVisibility[key]);
                item.querySelector('.genre-toggle').textContent = genreVisibility[key] ? '●' : '○';
            }
            
            createHeatmaps();
        }
        
        function toggleAll() {
            allVisible = !allVisible;
            for (const key of genreOrder) {
                genreVisibility[key] = allVisible;
            }
            buildGenreList();
            createHeatmaps();
        }
        
        function soloMode() {
            const toSolo = lastSelected || genreOrder.find(k => genreVisibility[k]) || genreOrder[0];
            for (const key of genreOrder) {
                genreVisibility[key] = (key === toSolo);
            }
            buildGenreList();
            createHeatmaps();
        }
        
        function toggleLocationType(type) {
            locationTypeVisibility[type] = !locationTypeVisibility[type];
            document.querySelector(`.header-btn[data-type="${type}"]`).classList.toggle('active', locationTypeVisibility[type]);
            createHeatmaps();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();
        });
    </script>
</body>
</html>
