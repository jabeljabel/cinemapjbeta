<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMAP - Filmed vs Represented Locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        /* Control Panel */
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(26, 26, 46, 0.95);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            width: 280px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .control-panel h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Mode Toggle Buttons */
        .mode-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-btn.filmed {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 2px solid transparent;
        }
        
        .mode-btn.filmed.active {
            background: rgba(255, 193, 7, 0.4);
            border-color: #ffc107;
        }
        
        .mode-btn.represented {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 2px solid transparent;
        }
        
        .mode-btn.represented.active {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4caf50;
        }
        
        .mode-btn.gap {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
            border: 2px solid transparent;
        }
        
        .mode-btn.gap.active {
            background: rgba(156, 39, 176, 0.4);
            border-color: #ce93d8;
        }
        
        /* Decade Slider */
        .decade-control {
            margin-bottom: 15px;
        }
        
        .decade-control label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .decade-control input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        
        .decade-value {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-top: 5px;
        }
        
        /* Stats Panel */
        .stats-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 12px;
            color: #aaa;
        }
        
        .stat-value {
            font-size: 12px;
            font-weight: 600;
        }
        
        .stat-value.filmed { color: #ffc107; }
        .stat-value.represented { color: #4caf50; }
        .stat-value.gap-positive { color: #4caf50; }
        .stat-value.gap-negative { color: #e74c3c; }
        
        /* Legend */
        .legend {
            margin-top: 15px;
        }
        
        .legend h3 {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .legend-scale {
            height: 15px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .legend-scale.filmed {
            background: linear-gradient(to right, rgba(255,193,7,0.2), rgba(255,193,7,1));
        }
        
        .legend-scale.represented {
            background: linear-gradient(to right, rgba(76,175,80,0.2), rgba(76,175,80,1));
        }
        
        .legend-scale.gap {
            background: linear-gradient(to right, #e74c3c, #fff, #4caf50);
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
        }
        
        /* Info Box */
        .info-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.95);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .info-box h3 {
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-box p {
            font-size: 12px;
            color: #aaa;
            line-height: 1.5;
        }
        
        /* Prefecture Popup */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 26, 46, 0.98);
            color: #fff;
            border-radius: 12px;
        }
        
        .leaflet-popup-content {
            margin: 12px;
        }
        
        .leaflet-popup-tip {
            background: rgba(26, 26, 46, 0.98);
        }
        
        .popup-content h4 {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .popup-stats {
            margin-bottom: 10px;
        }
        
        .popup-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        
        .popup-gap {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        
        .popup-gap.positive {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .popup-gap.negative {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .popup-gap.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        /* Back Button */
        .back-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(26, 26, 46, 0.95);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 1000;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(40, 40, 60, 0.95);
        }
        
        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.95);
            padding: 30px;
            border-radius: 12px;
            z-index: 2000;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #ffc107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Methodology Note */
        .methodology-note {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 11px;
            color: #888;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <a href="../" class="back-btn">
        ‚Üê Back to CineMAP
    </a>
    
    <div class="control-panel">
        <h2>üó∫Ô∏è Imagination Gap</h2>
        
        <div class="mode-toggle">
            <button class="mode-btn filmed active" onclick="setMode('filmed')">
                üìç Filmed
            </button>
            <button class="mode-btn represented" onclick="setMode('represented')">
                üìñ Mentioned
            </button>
            <button class="mode-btn gap" onclick="setMode('gap')">
                üéØ Gap
            </button>
        </div>
        
        <div class="decade-control">
            <label>Time Period</label>
            <input type="range" id="decadeSlider" min="1920" max="2020" step="10" value="2020">
            <div class="decade-value" id="decadeValue">All Time</div>
        </div>
        
        <div class="stats-panel">
            <div class="stat-row">
                <span class="stat-label">Total Filming Locations:</span>
                <span class="stat-value filmed" id="totalFilmed">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Mentioned Locations:</span>
                <span class="stat-value represented" id="totalRepresented">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Overall Gap:</span>
                <span class="stat-value" id="overallGap">-</span>
            </div>
        </div>
        
        <div class="legend" id="legend">
            <h3>Legend</h3>
            <div class="legend-scale filmed" id="legendScale"></div>
            <div class="legend-labels" id="legendLabels">
                <span>Low</span>
                <span>High</span>
            </div>
        </div>
        
        <div class="methodology-note">
            <strong>üìå About "Mentioned" locations:</strong><br>
            Place names extracted via NER from film titles, synopses, and subtitles. 
            Captures geographic references in narratives, not necessarily primary settings.
        </div>
    </div>
    
    <div class="info-box" id="infoBox">
        <h3>üé¨ Japanese Cinema Geography</h3>
        <p>
            Explore the "imagination gap" between where Japanese films are 
            <strong style="color:#ffc107">actually shot</strong> versus where their 
            <strong style="color:#4caf50">stories are set</strong>.
        </p>
        <p style="margin-top:10px">
            Click on any prefecture to see detailed statistics.
        </p>
    </div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Loading location data...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuration
        const DATA_URL = './filmed_vs_represented.json';
        const GEOJSON_URL = 'https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson';
        
        // State
        let map;
        let geojsonLayer;
        let data = null;
        let prefectureShapes = null;
        let currentMode = 'filmed';
        let currentDecade = 'all';
        
        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [36.5, 138],
                zoom: 5,
                minZoom: 4,
                maxZoom: 10
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap, ¬© CartoDB'
            }).addTo(map);
        }
        
        // Load data
        async function loadData() {
            try {
                // Load visualization data
                const dataResponse = await fetch(DATA_URL);
                data = await dataResponse.json();
                
                // Load GeoJSON
                const geoResponse = await fetch(GEOJSON_URL);
                prefectureShapes = await geoResponse.json();
                
                // Update stats
                document.getElementById('totalFilmed').textContent = 
                    data.metadata.total_filmed.toLocaleString();
                document.getElementById('totalRepresented').textContent = 
                    data.metadata.total_represented.toLocaleString();
                
                const gap = data.metadata.overall_gap;
                const gapEl = document.getElementById('overallGap');
                gapEl.textContent = (gap >= 0 ? '+' : '') + gap.toFixed(1) + '%';
                gapEl.className = 'stat-value ' + (gap >= 0 ? 'gap-positive' : 'gap-negative');
                
                // Render map
                renderChoropleth();
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color:#e74c3c">Error loading data</div>';
            }
        }
        
        // Get value for prefecture based on mode and decade
        function getPrefectureValue(prefName) {
            const prefData = data.prefectures[prefName];
            if (!prefData) return 0;
            
            if (currentDecade === 'all') {
                switch (currentMode) {
                    case 'filmed': return prefData.filmed_count;
                    case 'represented': return prefData.represented_count;
                    case 'gap': return prefData.gap_percentage;
                }
            } else {
                const decadeData = prefData.by_decade[currentDecade];
                if (!decadeData) return 0;
                switch (currentMode) {
                    case 'filmed': return decadeData.filmed || 0;
                    case 'represented': return decadeData.represented || 0;
                    case 'gap': {
                        const f = decadeData.filmed || 0;
                        const r = decadeData.represented || 0;
                        return f > 0 ? ((r - f) / f) * 100 : (r > 0 ? 100 : 0);
                    }
                }
            }
            return 0;
        }
        
        // Get color based on value and mode
        function getColor(value) {
            if (currentMode === 'gap') {
                // Diverging scale: red (-) to white (0) to green (+)
                const clampedValue = Math.max(-100, Math.min(100, value));
                if (clampedValue < 0) {
                    const t = (clampedValue + 100) / 100;
                    return `rgba(231, 76, 60, ${1 - t * 0.7})`;
                } else {
                    const t = clampedValue / 100;
                    return `rgba(76, 175, 80, ${t * 0.8 + 0.2})`;
                }
            } else {
                // Sequential scale
                const color = currentMode === 'filmed' ? '255,193,7' : '76,175,80';
                const maxVal = currentMode === 'filmed' ? 15000 : 20000;
                const opacity = Math.min(value / maxVal, 1) * 0.8 + 0.2;
                return `rgba(${color},${opacity})`;
            }
        }
        
        // Style function for GeoJSON
        function styleFeature(feature) {
            const prefName = feature.properties.nam_ja;
            const value = getPrefectureValue(prefName);
            
            return {
                fillColor: getColor(value),
                weight: 1,
                opacity: 0.8,
                color: '#fff',
                fillOpacity: 0.8
            };
        }
        
        // Create popup content
        function createPopupContent(prefName) {
            const prefData = data.prefectures[prefName];
            if (!prefData) {
                return `<div class="popup-content"><h4>${prefName}</h4><p>No data available</p></div>`;
            }
            
            let filmed, represented, gap;
            
            if (currentDecade === 'all') {
                filmed = prefData.filmed_count;
                represented = prefData.represented_count;
                gap = prefData.gap_percentage;
            } else {
                const decadeData = prefData.by_decade[currentDecade] || {};
                filmed = decadeData.filmed || 0;
                represented = decadeData.represented || 0;
                gap = filmed > 0 ? ((represented - filmed) / filmed) * 100 : (represented > 0 ? 100 : 0);
            }
            
            const gapClass = gap > 5 ? 'positive' : gap < -5 ? 'negative' : 'neutral';
            const gapText = gap > 0 
                ? `+${gap.toFixed(1)}% more in stories than filming`
                : gap < 0 
                    ? `${Math.abs(gap).toFixed(1)}% more filming than stories`
                    : 'Balanced';
            
            return `
                <div class="popup-content">
                    <h4>${prefName}</h4>
                    <div class="popup-stats">
                        <div class="popup-stat">
                            <span style="color:#ffc107">üìç Filmed:</span>
                            <span>${filmed.toLocaleString()} locations</span>
                        </div>
                        <div class="popup-stat">
                            <span style="color:#4caf50">üìñ Mentioned:</span>
                            <span>${represented.toLocaleString()} locations</span>
                        </div>
                    </div>
                    <div class="popup-gap ${gapClass}">
                        ${gapText}
                    </div>
                </div>
            `;
        }
        
        // Render choropleth
        function renderChoropleth() {
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }
            
            geojsonLayer = L.geoJSON(prefectureShapes, {
                style: styleFeature,
                onEachFeature: (feature, layer) => {
                    const prefName = feature.properties.nam_ja;
                    
                    layer.on({
                        mouseover: (e) => {
                            e.target.setStyle({
                                weight: 3,
                                color: '#fff'
                            });
                            e.target.bringToFront();
                        },
                        mouseout: (e) => {
                            geojsonLayer.resetStyle(e.target);
                        },
                        click: (e) => {
                            const popup = L.popup()
                                .setLatLng(e.latlng)
                                .setContent(createPopupContent(prefName))
                                .openOn(map);
                        }
                    });
                }
            }).addTo(map);
            
            updateLegend();
        }
        
        // Update legend based on mode
        function updateLegend() {
            const scale = document.getElementById('legendScale');
            const labels = document.getElementById('legendLabels');
            
            scale.className = 'legend-scale ' + currentMode;
            
            if (currentMode === 'gap') {
                labels.innerHTML = '<span>Over-filmed</span><span>Balanced</span><span>Over-represented</span>';
            } else {
                labels.innerHTML = '<span>Low</span><span>High</span>';
            }
        }
        
        // Set visualization mode
        function setMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.mode-btn.' + mode).classList.add('active');
            
            // Re-render
            renderChoropleth();
        }
        
        // Handle decade slider
        document.getElementById('decadeSlider').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            
            if (value >= 2020) {
                currentDecade = 'all';
                document.getElementById('decadeValue').textContent = 'All Time';
            } else {
                currentDecade = value.toString();
                document.getElementById('decadeValue').textContent = `${value}s`;
            }
            
            renderChoropleth();
        });
        
        // Initialize
        initMap();
        loadData();
    </script>
</body>
</html>
