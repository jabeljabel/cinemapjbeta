<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMAP - Directors by Prefecture</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .header h1 {
            font-size: 1.4rem;
            color: #fff;
        }
        
        .header h1 span {
            color: #ffd700;
        }
        
        .header-links {
            display: flex;
            gap: 15px;
        }
        
        .header-links a {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        
        .header-links a:hover {
            color: #ffd700;
        }
        
        /* Main layout */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 350px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        
        .sidebar h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #ffd700;
        }
        
        .sidebar h3 {
            font-size: 0.95rem;
            margin: 20px 0 10px;
            color: #ccc;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        /* Filter controls */
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px;
            background: #1a1a2e;
            border: 1px solid #333;
            color: #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .toggle-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .toggle-btn {
            padding: 6px 12px;
            background: #1a1a2e;
            border: 1px solid #444;
            color: #888;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: #ffd700;
            color: #1a1a2e;
            border-color: #ffd700;
        }
        
        .toggle-btn:hover:not(.active) {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        /* Ranking list */
        .ranking-list {
            list-style: none;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: #1a1a2e;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .ranking-item:hover {
            background: #222;
        }
        
        .ranking-rank {
            width: 25px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .ranking-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 10px;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-size: 0.9rem;
            color: #e0e0e0;
        }
        
        .ranking-name-jp {
            font-size: 0.75rem;
            color: #888;
        }
        
        .ranking-count {
            font-size: 0.8rem;
            color: #ffd700;
        }
        
        /* Prefecture detail panel */
        .detail-panel {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .detail-panel.visible {
            display: block;
        }
        
        .detail-panel h4 {
            font-size: 1rem;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .detail-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-stat {
            text-align: center;
            padding: 10px;
            background: #16213e;
            border-radius: 4px;
        }
        
        .detail-stat-value {
            font-size: 1.2rem;
            color: #ffd700;
        }
        
        .detail-stat-label {
            font-size: 0.75rem;
            color: #888;
        }
        
        .detail-director-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .detail-director {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            font-size: 0.85rem;
        }
        
        .detail-director:last-child {
            border-bottom: none;
        }
        
        .detail-director-name {
            flex: 1;
        }
        
        .detail-director-name small {
            color: #666;
            display: block;
            font-size: 0.75rem;
        }
        
        .detail-director-films {
            color: #ffd700;
            margin-left: 10px;
        }
        
        .gender-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 0.65rem;
            margin-left: 5px;
        }
        
        .gender-m {
            background: #4a90d9;
            color: #fff;
        }
        
        .gender-f {
            background: #d94a7b;
            color: #fff;
        }
        
        /* Map container */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #0f0f23;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 250px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .legend h4 {
            font-size: 0.85rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            margin-right: 8px;
        }
        
        /* Info box */
        .info-box {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(22, 33, 62, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 0.85rem;
        }
        
        .info-box strong {
            color: #ffd700;
        }
        
        /* Loading overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading p {
            margin-top: 15px;
            color: #888;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
            
            .map-container {
                height: 60vh;
            }
            
            .legend {
                bottom: 10px;
                right: 10px;
                max-width: 150px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading director data...</p>
    </div>
    
    <!-- Header -->
    <div class="header">
        <h1>CineMAP - <span>Directors by Prefecture</span></h1>
        <div class="header-links">
            <a href="../index.html">‚Üê Splash</a>
            <a href="../main.html">Main Map</a>
            <a href="studios.html">Studios</a>
            <a href="actors.html">Actors</a>
            <a href="genres.html">Genres</a>
        </div>
    </div>
    
    <!-- Main container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Filter Options</h2>
            
            <div class="filter-group">
                <label>Gender Filter</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" data-gender="all">All</button>
                    <button class="toggle-btn" data-gender="M">Male</button>
                    <button class="toggle-btn" data-gender="F">Female</button>
                </div>
            </div>
            
            <div class="filter-group">
                <label>Decade Filter</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" data-era="all">All</button>
                    <button class="toggle-btn" data-era="1920s">20s</button>
                    <button class="toggle-btn" data-era="1930s">30s</button>
                    <button class="toggle-btn" data-era="1940s">40s</button>
                    <button class="toggle-btn" data-era="1950s">50s</button>
                    <button class="toggle-btn" data-era="1960s">60s</button>
                    <button class="toggle-btn" data-era="1970s">70s</button>
                    <button class="toggle-btn" data-era="1980s">80s</button>
                    <button class="toggle-btn" data-era="1990s">90s</button>
                    <button class="toggle-btn" data-era="2000s">00s</button>
                    <button class="toggle-btn" data-era="2010s">10s</button>
                </div>
            </div>
            
            <div class="filter-group">
                <label>Minimum Films per Prefecture</label>
                <select id="minFilms">
                    <option value="1">1+ films</option>
                    <option value="5" selected>5+ films</option>
                    <option value="10">10+ films</option>
                    <option value="25">25+ films</option>
                    <option value="50">50+ films</option>
                </select>
            </div>
            
            <h3>üèÜ Top Directors <span id="filterContext" style="font-weight: normal; color: #888;">(All Time)</span></h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">
                By prefectures dominated
            </p>
            <ul class="ranking-list" id="dominantDirectorsList">
                <!-- Populated by JS -->
            </ul>
            
            <h3>üìç Selected Prefecture</h3>
            <div class="detail-panel" id="detailPanel">
                <h4 id="detailPrefName">-</h4>
                <div class="detail-stats">
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="detailTopPct">-</div>
                        <div class="detail-stat-label">Top Director Share</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="detailDirectorCount">-</div>
                        <div class="detail-stat-label">Unique Directors</div>
                    </div>
                </div>
                <div class="detail-director-list" id="detailDirectorList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <p id="detailPlaceholder" style="font-size: 0.85rem; color: #666;">
                Click a prefecture on the map to see director breakdown
            </p>
        </div>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <div class="info-box">
                <strong id="hoverInfo">Hover over a prefecture</strong>
            </div>
            
            <div class="legend">
                <h4>Legend</h4>
                <div id="legendItems">
                    <!-- Populated by JS -->
                </div>
                <div style="margin-top: 10px; font-size: 0.7rem; color: #666;">
                    (n) = prefectures dominated<br>
                    Opacity = % share
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration
        const CONFIG = {
            dataFile: 'director_prefecture.json',
            geoJsonUrl: 'https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson',
            mapCenter: [36.5, 138],
            mapZoom: 5
        };
        
        // State
        let map = null;
        let geoJsonLayer = null;
        let directorData = null;
        let prefectureGeoJson = null;
        let currentFilters = {
            gender: 'all',
            era: 'all',
            minFilms: 5
        };
        
        // Director colors - expanded bright palette (40 colors)
        const DIRECTOR_COLORS = [
            '#ff6b6b', // Bright red
            '#4ecdc4', // Bright teal
            '#ffe66d', // Yellow
            '#ff8c42', // Orange
            '#a8e6cf', // Mint green
            '#fdcb6e', // Golden yellow
            '#74b9ff', // Sky blue
            '#ff7979', // Coral
            '#55efc4', // Aquamarine
            '#ffeaa7', // Light yellow
            '#81ecec', // Cyan
            '#fab1a0', // Peach
            '#a29bfe', // Lavender
            '#fd79a8', // Pink
            '#00cec9', // Turquoise
            '#e17055', // Terra cotta
            '#00b894', // Emerald
            '#6c5ce7', // Purple
            '#f8b500', // Sunflower
            '#e84393', // Magenta
            '#00d2d3', // Bright cyan
            '#ff9ff3', // Light pink
            '#54a0ff', // Dodger blue
            '#5f27cd', // Royal purple
            '#c8d6e5', // Light steel
            '#feca57', // Casandora yellow
            '#1dd1a1', // Caribbean green
            '#ff6b81', // Wild watermelon
            '#48dbfb', // Turquoise blue
            '#f368e0', // Orchid
            '#25CCF7', // Bright sky blue
            '#EAB543', // Bright gold
            '#58B19F', // Sage
            '#D6A2E8', // Soft purple
            '#82ccdd', // Sky blue light
            '#b8e994', // Light green
            '#78e08f', // Grass green
            '#fa983a', // Bright orange
            '#eb2f06', // Red orange
            '#1e3799'  // Royal blue
        ];
        
        // Director to color mapping (built dynamically)
        let directorColorMap = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            try {
                // Initialize map
                map = L.map('map', {
                    center: CONFIG.mapCenter,
                    zoom: CONFIG.mapZoom,
                    minZoom: 4,
                    maxZoom: 10
                });
                
                // Add dark base layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
                
                // Load data
                await loadData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Hide loading
                document.getElementById('loading').classList.add('hidden');
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.querySelector('.loading p').textContent = 'Error loading data: ' + error.message;
            }
        }
        
        async function loadData() {
            // Load director data
            const directorResponse = await fetch(CONFIG.dataFile);
            if (!directorResponse.ok) {
                throw new Error(`Failed to load ${CONFIG.dataFile}`);
            }
            directorData = await directorResponse.json();
            
            // Load prefecture GeoJSON
            const geoResponse = await fetch(CONFIG.geoJsonUrl);
            if (!geoResponse.ok) {
                throw new Error('Failed to load prefecture boundaries');
            }
            prefectureGeoJson = await geoResponse.json();
            
            // Build color mapping for dominant directors
            buildDirectorColorMap();
            
            // Render map
            renderMap();
            
            // Populate dominant directors list
            populateDominantDirectorsList();
        }
        
        function buildDirectorColorMap() {
            // Reset color map
            directorColorMap = {};
            
            // Collect all directors who are currently top in at least one prefecture (with filters applied)
            const topDirectors = new Map(); // people_id -> {director data, count of prefectures}
            
            Object.values(directorData.prefectures).forEach(prefData => {
                const topDirector = getFilteredTopDirector(prefData);
                if (topDirector) {
                    if (topDirectors.has(topDirector.people_id)) {
                        topDirectors.get(topDirector.people_id).count++;
                    } else {
                        topDirectors.set(topDirector.people_id, {
                            ...topDirector,
                            count: 1
                        });
                    }
                }
            });
            
            // Sort by number of prefectures dominated (descending)
            const sortedDirectors = [...topDirectors.entries()]
                .sort((a, b) => b[1].count - a[1].count);
            
            // Assign colors - every visible director gets a unique color
            sortedDirectors.forEach(([pid, data], index) => {
                directorColorMap[pid] = DIRECTOR_COLORS[index % DIRECTOR_COLORS.length];
            });
            
            console.log(`Assigned colors to ${sortedDirectors.length} directors for current filter`);
            
            return sortedDirectors;
        }
        
        function getFilteredTopDirector(prefData) {
            if (!prefData || !prefData.top_directors) return null;
            
            const minFilms = currentFilters.minFilms;
            
            for (const director of prefData.top_directors) {
                // Apply minimum films filter
                if (director.film_count < minFilms) continue;
                
                // Apply gender filter
                if (currentFilters.gender !== 'all') {
                    const g = director.gender || 'Unknown';
                    if (currentFilters.gender === 'M' && !['M', 'Male'].includes(g)) continue;
                    if (currentFilters.gender === 'F' && !['F', 'Female'].includes(g)) continue;
                }
                
                // Apply decade filter - check if director was active during this decade
                if (currentFilters.era !== 'all') {
                    const firstYear = director.first_year;
                    const lastYear = director.last_year;
                    
                    if (!firstYear || !lastYear) continue;
                    
                    // Parse decade filter (e.g., "1960s" -> 1960-1969)
                    const decadeMatch = currentFilters.era.match(/(\d{4})s/);
                    if (decadeMatch) {
                        const decadeStart = parseInt(decadeMatch[1]);
                        const decadeEnd = decadeStart + 9;
                        
                        // Director must have been active during this decade
                        // (their career overlaps with the decade)
                        if (lastYear < decadeStart || firstYear > decadeEnd) continue;
                    }
                }
                
                return director;
            }
            return null;
        }
        
        function getDirectorColor(directorId) {
            if (directorColorMap[directorId]) {
                return directorColorMap[directorId];
            }
            // Fallback: generate color based on ID
            return DIRECTOR_COLORS[directorId % DIRECTOR_COLORS.length];
        }
        
        function renderMap() {
            // Rebuild color map based on current filters
            const sortedDirectors = buildDirectorColorMap();
            
            // Update filter context text
            updateFilterContext();
            
            // Remove existing layer
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }
            
            // Create new layer
            geoJsonLayer = L.geoJSON(prefectureGeoJson, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            // Update legend and dominant directors list
            updateLegend();
            updateDominantDirectorsList(sortedDirectors);
        }
        
        function styleFeature(feature) {
            const prefName = feature.properties.nam_ja || feature.properties.name;
            const prefData = directorData.prefectures[prefName];
            const topDirector = getFilteredTopDirector(prefData);
            
            if (!topDirector) {
                return {
                    fillColor: '#444',
                    weight: 1,
                    opacity: 0.5,
                    color: '#555',
                    fillOpacity: 0.4
                };
            }
            
            // Calculate opacity based on percentage dominance
            const pct = topDirector.percentage || 0;
            const opacity = Math.max(0.5, Math.min(0.95, 0.4 + pct / 15));
            
            return {
                fillColor: getDirectorColor(topDirector.people_id),
                weight: 1,
                opacity: 0.8,
                color: '#444',
                fillOpacity: opacity
            };
        }
        
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: selectPrefecture
            });
        }
        
        function highlightFeature(e) {
            const layer = e.target;
            const prefName = layer.feature.properties.nam_ja || layer.feature.properties.name;
            const prefData = directorData.prefectures[prefName];
            const topDirector = getFilteredTopDirector(prefData);
            
            layer.setStyle({
                weight: 3,
                color: '#fff',
                fillOpacity: 0.9
            });
            
            layer.bringToFront();
            
            // Update hover info
            const infoEl = document.getElementById('hoverInfo');
            if (topDirector) {
                const name = topDirector.english_name || topDirector.japanese_name || 'Unknown';
                const pct = topDirector.percentage ? topDirector.percentage.toFixed(1) + '%' : '';
                infoEl.innerHTML = `<strong>${prefName}</strong><br>${name}: ${pct} (${topDirector.film_count} films)`;
            } else {
                infoEl.innerHTML = `<strong>${prefName}</strong><br>No matching directors`;
            }
        }
        
        function resetHighlight(e) {
            geoJsonLayer.resetStyle(e.target);
            document.getElementById('hoverInfo').innerHTML = 'Hover over a prefecture';
        }
        
        function selectPrefecture(e) {
            const prefName = e.target.feature.properties.nam_ja || e.target.feature.properties.name;
            showPrefectureDetail(prefName);
        }
        
        function showPrefectureDetail(prefName) {
            const prefData = directorData.prefectures[prefName];
            const panel = document.getElementById('detailPanel');
            const placeholder = document.getElementById('detailPlaceholder');
            
            if (!prefData) {
                panel.classList.remove('visible');
                placeholder.style.display = 'block';
                return;
            }
            
            panel.classList.add('visible');
            placeholder.style.display = 'none';
            
            document.getElementById('detailPrefName').textContent = prefName;
            
            // Get top director percentage
            const topDirector = getFilteredTopDirector(prefData);
            const topPct = topDirector && topDirector.percentage ? topDirector.percentage.toFixed(1) + '%' : '-';
            document.getElementById('detailTopPct').textContent = topPct;
            document.getElementById('detailDirectorCount').textContent = prefData.director_count.toLocaleString();
            
            // Build director list
            const listEl = document.getElementById('detailDirectorList');
            listEl.innerHTML = '';
            
            const minFilms = currentFilters.minFilms;
            let filteredDirectors = prefData.top_directors.filter(a => a.film_count >= minFilms);
            
            // Apply gender filter for list
            if (currentFilters.gender !== 'all') {
                filteredDirectors = filteredDirectors.filter(a => {
                    const g = a.gender || 'Unknown';
                    if (currentFilters.gender === 'M') return ['M', 'Male'].includes(g);
                    if (currentFilters.gender === 'F') return ['F', 'Female'].includes(g);
                    return true;
                });
            }
            
            filteredDirectors.slice(0, 15).forEach((director, i) => {
                const div = document.createElement('div');
                div.className = 'detail-director';
                
                const genderBadge = getGenderBadge(director.gender);
                const years = director.first_year && director.last_year 
                    ? `${director.first_year}-${director.last_year}` 
                    : '';
                const pct = director.percentage ? director.percentage.toFixed(1) + '%' : '';
                
                div.innerHTML = `
                    <div class="detail-director-name">
                        ${i + 1}. ${director.english_name || director.japanese_name || 'Unknown'}${genderBadge}
                        <small>${director.japanese_name && director.english_name ? director.japanese_name : ''} ${years}</small>
                    </div>
                    <div class="detail-director-films">${pct} <small>(${director.film_count})</small></div>
                `;
                listEl.appendChild(div);
            });
        }
        
        function getGenderBadge(gender) {
            if (!gender) return '';
            if (['M', 'Male'].includes(gender)) {
                return '<span class="gender-badge gender-m">M</span>';
            }
            if (['F', 'Female'].includes(gender)) {
                return '<span class="gender-badge gender-f">F</span>';
            }
            return '';
        }
        
        function populateDominantDirectorsList() {
            // Initial population - will be replaced by updateDominantDirectorsList on filter change
            const sortedDirectors = buildDirectorColorMap();
            updateDominantDirectorsList(sortedDirectors);
        }
        
        function updateDominantDirectorsList(sortedDirectors) {
            const listEl = document.getElementById('dominantDirectorsList');
            listEl.innerHTML = '';
            
            if (!sortedDirectors || sortedDirectors.length === 0) {
                listEl.innerHTML = '<li style="color: #666; font-size: 0.85rem;">No directors match current filters</li>';
                return;
            }
            
            // Show top 15 directors for current filter
            sortedDirectors.slice(0, 15).forEach(([pid, director], i) => {
                const li = document.createElement('li');
                li.className = 'ranking-item';
                
                const color = directorColorMap[pid];
                const genderBadge = getGenderBadge(director.gender);
                
                li.innerHTML = `
                    <span class="ranking-rank">${i + 1}</span>
                    <div class="ranking-color" style="background: ${color}"></div>
                    <div class="ranking-info">
                        <div class="ranking-name">${director.english_name || director.japanese_name || 'Unknown'}${genderBadge}</div>
                        <div class="ranking-name-jp">${director.japanese_name && director.english_name ? director.japanese_name : ''}</div>
                    </div>
                    <span class="ranking-count">${director.count} pref</span>
                `;
                
                listEl.appendChild(li);
            });
        }
        
        function updateFilterContext() {
            const contextEl = document.getElementById('filterContext');
            let parts = [];
            
            if (currentFilters.era !== 'all') {
                parts.push(currentFilters.era);
            }
            if (currentFilters.gender === 'M') {
                parts.push('Male');
            } else if (currentFilters.gender === 'F') {
                parts.push('Female');
            }
            
            if (parts.length > 0) {
                contextEl.textContent = `(${parts.join(', ')})`;
            } else {
                contextEl.textContent = '(All Time)';
            }
        }
        
        function updateLegend() {
            const legendEl = document.getElementById('legendItems');
            legendEl.innerHTML = '';
            
            // Get current top directors being displayed
            const displayedDirectors = new Map();
            
            Object.entries(directorData.prefectures).forEach(([prefName, prefData]) => {
                const topDirector = getFilteredTopDirector(prefData);
                if (topDirector) {
                    const existing = displayedDirectors.get(topDirector.people_id);
                    if (existing) {
                        existing.count++;
                    } else {
                        displayedDirectors.set(topDirector.people_id, {
                            name: topDirector.english_name || topDirector.japanese_name || 'Unknown',
                            color: getDirectorColor(topDirector.people_id),
                            count: 1
                        });
                    }
                }
            });
            
            // Sort by count and show top 12
            const sortedDirectors = [...displayedDirectors.values()]
                .sort((a, b) => b.count - a.count)
                .slice(0, 12);
            
            sortedDirectors.forEach(director => {
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = `
                    <div class="legend-color" style="background: ${director.color}"></div>
                    <span>${director.name} (${director.count})</span>
                `;
                legendEl.appendChild(div);
            });
        }
        
        function setupEventListeners() {
            // Gender toggles
            document.querySelectorAll('[data-gender]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-gender]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilters.gender = btn.dataset.gender;
                    renderMap();
                });
            });
            
            // Era toggles
            document.querySelectorAll('[data-era]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-era]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilters.era = btn.dataset.era;
                    renderMap();
                });
            });
            
            // Min films select
            document.getElementById('minFilms').addEventListener('change', (e) => {
                currentFilters.minFilms = parseInt(e.target.value);
                renderMap();
            });
        }
    </script>
</body>
</html>
